# MVCC(다중 버전 동시성 제어)

1. 동시성 제어(Concurrency Control)
   동시성 제어란 DBMS가 다수의 사용자 사이에서 동시에 작용하는 다중 트랜잭션의 상호간섭 작용에서 Database를 보호하는 것.
   다수 사용자의 동시 접속을 위해 DBMS는 동시성 제어를 할 수 있도록 Lock 기능과 SET TRNSACTION 명령어를 이용해 트랜잭션의 격리성 수준을 조정할 수 있는 기능도 제공한다.
   이렇게 동시성을 제어하는 방법에는 낙관적 동시성 제어와 비관적 동시성 제어가 있다.

> 낙관적 동시성 제어(Optimistic Concurrency Control)

- 사용자들이 같은 데이터를 동시에 수정하지 않을 것이라고 가정
- 데이터를 읽는 시점에 Lock을 걸지 않는 대신 수정 시점에 값이 변경됐는지를 반드시 검사

> 비관적 동시성 제어(Pessimistic Concurrency Control)

- 사용자들이 같은 데이터를 동시에 수정할 것이라고 가정
- 데이터를 읽는 시점에 Lock을 걸고, 트랜잭션이 완료될 때까지 이를 유지
- SELECT 시점에 Lock을 거는 비관적 동시성 제어는 시스템의 동시성을 심각하게 떨어뜨릴 수 있어서 wait 또는 nowait 옵션과 함께 사용해야 함

동시성 제어의 목표는 동시에 `실행되는 트랜잭션 수를 최대화` 하면서 `입력, 수정, 삭제, 검색 시 데이터의 무결성을 유지`하는데 있다.

## 공유락[Shared Lock]과 배타락(Exclusive Lock)

비관적 동시성 제어를 위한 대표적인 방법으로 Lock이 있는데, 크게 공유락과 배타락이 있다.

- 공유락: 읽기 잠금
- 배타락: 쓰기 잠금

동일한 레코드에 대해 각각 공유락과 배타락을 가져간 경우의 동작은 다음과 같다.

- 1번 트랜잭션이 공유락을 가져간 경우
  - 2번 트랜잭션이 데이터를 읽는 경우는 데이터가 일관되므로, 2번 트랜잭션이 또 다른공유락을 가져가면서 동시에 처리함
  - 2번 트랜잭션이 데이터를 쓰는 경우는 1번 트랜잭션과 데이터가 달라질 수 있으므로 1번 트랜잭션 종료까지 기다려야 함
- 1번 트랜잭션이 배타락을 가져간 경우
  - 2번 트랜잭션이 데이터를 읽는 경우, 1번 트랜잭션이 데이터를 변경할 수 있으므로 기다림
  - 2번 트랜잭션이 데이터를 쓰는 경우에도, 1번 트랜잭션이 데이터를 변경할 수 있으므로 기다림

획득한 락을 해제하는 방법은 커밋과 롤백밖에 없다.
이러한 방식의 일반적인 Locking 캐머니즘은 구현이 간단한 반면에 아래와 같은 문제점을 가지고 있다.

## Locking 메커니즘의 문제점

- 읽기 작업과 쓰기 작업이 서로 방해를 일으키기 때문에 동시성 문제가 발생
- 데이터에 일관성 문제가 생기는 경우도 있어서 Locking을 더 오래 유지하거나 테이블 레벨의 Lock을 사용해야 하고, 동시성 저하가 발생

이러한 문제점들을 해결하기 위해 MVCC라는(Multi-Version Concurrency Control, 다중 버전 동시성 제어)이 탄생하게 되었다.
