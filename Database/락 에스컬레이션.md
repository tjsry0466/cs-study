# 락 에스컬레이션

![나락도 락이다](./assets/나락도%20락이다.jpg)

락 에스컬레이션(Lock Escalation)은 데이터베이스 관리 시스템(DBMS)에서 사용되는 성능 최적화 메커니즘입니다. 트랜잭션이 매우 많은 수의 세밀한 락(주로 행 락)을 획득할 때, 시스템 리소스를 효율적으로 관리하기 위해 더 큰 범위의 락(예: 페이지 락, 테이블 락)으로 전환하는 과정입니다. 락 에스컬레이션은 데이터베이스의 성능을 유지하기 위한 조치이지만, 동시에 동시성에 부정적인 영향을 줄 수 있습니다.

### 1. **락 에스컬레이션의 필요성**

트랜잭션이 특정 테이블에서 많은 수의 행을 락해야 하는 경우, 각 행에 대해 개별 락을 설정하는 것은 락 관리 오버헤드를 증가시킵니다. 각 락은 메모리 자원을 소비하고, 락을 관리하는 데 필요한 메타데이터가 많아지면 성능에 영향을 미칠 수 있습니다. 이러한 상황을 방지하기 위해 데이터베이스는 특정 임계값에 도달했을 때 개별 락을 더 큰 범위의 락으로 전환합니다. 이 과정이 바로 락 에스컬레이션입니다.

### 2. **락 에스컬레이션의 동작 방식**

락 에스컬레이션은 특정 기준에 따라 발생합니다. 이 기준은 DBMS마다 다를 수 있지만, 일반적으로 다음과 같은 요소들이 영향을 미칩니다:

- **락의 수**: 특정 테이블에서 트랜잭션이 획득한 락의 개수가 시스템이 정한 임계값을 초과할 때 에스컬레이션이 발생할 수 있습니다.
- **메모리 사용량**: 트랜잭션이 너무 많은 메모리를 사용하여 락을 관리할 때, 시스템은 메모리 사용량을 줄이기 위해 에스컬레이션을 수행할 수 있습니다.
- **락의 타입**: 일부 DBMS에서는 특정 유형의 락(예: 공유 락 또는 배타 락)이 많이 걸렸을 때 에스컬레이션을 트리거할 수 있습니다.

### 3. **락 에스컬레이션의 과정**

락 에스컬레이션이 발생하면 다음과 같은 일련의 과정이 진행됩니다:

1. **임계값 초과 감지**: 트랜잭션이 설정된 임계값을 초과하는 수의 락을 획득했을 때, DBMS는 락 에스컬레이션을 고려합니다.

2. **락 전환**: DBMS는 현재 트랜잭션이 소유한 개별 락을 해제하고, 더 큰 범위(예: 페이지 또는 테이블)에 대한 락을 설정합니다. 예를 들어, 행 락 수가 너무 많으면 해당 행들이 포함된 페이지나 전체 테이블에 락을 거는 방식으로 전환됩니다.

3. **동시성 영향**: 에스컬레이션된 락은 더 큰 범위를 커버하므로, 다른 트랜잭션들이 해당 자원에 접근하려고 할 때 더 자주 차단될 수 있습니다. 이는 동시성에 부정적인 영향을 미칠 수 있지만, 시스템 전체의 성능을 높이는 데 기여할 수 있습니다.

### 4. **락 에스컬레이션의 장점과 단점**

**장점**:

- **성능 개선**: 락 에스컬레이션은 락을 관리하는 데 필요한 메타데이터의 양을 줄여 성능을 개선할 수 있습니다. 특히 대규모 트랜잭션이 많이 발생하는 시스템에서는 락 관리의 오버헤드를 줄이는 것이 중요합니다.
- **메모리 사용량 감소**: 락을 개별적으로 관리하는 것보다 더 큰 범위의 락 하나를 관리하는 것이 메모리 효율이 높습니다.

**단점**:

- **동시성 감소**: 에스컬레이션된 락은 더 큰 범위를 차지하므로, 동시에 접근할 수 있는 트랜잭션의 수가 줄어들게 됩니다. 이는 동시성 처리에 부정적인 영향을 미칠 수 있습니다.
- **Deadlock 발생 가능성 증가**: 더 큰 범위의 락을 걸게 되면, 다른 트랜잭션과 충돌할 가능성이 높아져 데드락의 위험이 커질 수 있습니다.

### 5. **락 에스컬레이션 방지 및 제어**

대부분의 DBMS는 기본적으로 락 에스컬레이션을 자동으로 수행하지만, 필요에 따라 이를 제어할 수 있는 방법을 제공합니다.

- **임계값 조정**: DBMS의 설정을 통해 락 에스컬레이션의 임계값을 조정할 수 있습니다. 예를 들어, 특정 테이블에 대해 에스컬레이션이 발생하지 않도록 임계값을 높일 수 있습니다.
- **테이블별 설정**: 특정 테이블에 대해 락 에스컬레이션을 비활성화하거나, 특정 상황에서만 발생하도록 설정할 수 있습니다.
- **쿼리 최적화**: 트랜잭션이 너무 많은 행을 동시에 락하지 않도록 쿼리를 최적화함으로써 에스컬레이션을 예방할 수 있습니다.

### 6. **예시**

예를 들어, 만약 트랜잭션이 `UPDATE` 쿼리를 통해 수천 개의 행을 수정하고 있으며, 이때 각 행에 개별적으로 락이 걸린다면, 시스템은 어느 시점에서 더 큰 범위의 락으로 에스컬레이션할 수 있습니다. 이때 페이지 또는 테이블 전체에 락이 걸리게 되면, 해당 자원에 대한 다른 트랜잭션의 접근이 차단될 수 있습니다.

이러한 락 에스컬레이션은 성능과 동시성 간의 트레이드오프를 수반하며, 데이터베이스 관리자는 이를 이해하고 최적화 전략을 수립해야 합니다.
