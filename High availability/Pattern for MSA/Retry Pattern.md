# 재시도 패턴 (Retry Pattern) + 지수 백오프 패턴 (Exponential Backoff Pattern)

## 1. 개요

**재시도 패턴**(Retry Pattern)은 시스템에서 요청이 실패했을 때, 즉시 포기하지 않고 일정 시간 후에 동일한 요청을 재시도하는 패턴입니다. 네트워크 장애나 외부 서비스 일시적 장애와 같은 단기적인 문제에 대응하는 데 유용합니다.

**지수 백오프 패턴** (Exponential Backoff Pattern)은 재시도 간격을 점진적으로 늘려가며 재시도를 수행하는 방식입니다. 이를 통해 실패한 요청에 대해 무분별하게 재시도하는 것을 방지하고, 시스템 과부하를 줄일 수 있습니다. 두 패턴을 결합하면 시스템 성능 저하 없이 신뢰성 있는 서비스 운영이 가능합니다.

## 2. 재시도 패턴의 필요성

재시도 패턴은 다음과 같은 상황에서 유용합니다:

- **일시적인 네트워크 문제**: 네트워크가 일시적으로 불안정할 때 재시도를 통해 문제를 해결할 수 있습니다.
- **외부 서비스의 단기 장애**: 외부 API나 서비스가 일시적으로 응답하지 않으면, 일정 시간 후 재시도하면 정상적으로 응답할 가능성이 있습니다.
- **비동기 작업 실패**: 큐 기반 비동기 작업에서 메시지 전달 실패 시, 재시도를 통해 메시지가 다시 성공적으로 처리될 수 있습니다.

## 3. 지수 백오프 패턴의 필요성

단순한 재시도는 문제 해결에 도움이 될 수 있지만, 실패한 요청을 즉시 반복하면 시스템에 과도한 부하가 발생할 수 있습니다. **지수 백오프 패턴**은 이러한 문제를 해결하기 위해 재시도 간격을 점차적으로 늘리며, 시스템이 정상 상태로 돌아올 시간을 확보해줍니다. 예를 들어, 첫 번째 재시도는 1초 후에, 두 번째 재시도는 2초 후에, 세 번째는 4초 후에 이루어집니다.

이 방식은 다음과 같은 상황에서 유용합니다:

- **시스템의 안정성 보호**: 서버나 네트워크가 과부하 상태일 때 재시도 간격을 늘려 과부하가 더 악화되는 것을 방지합니다.
- **서비스 복구 시간 확보**: 장애가 발생한 서비스가 복구될 때까지 충분한 대기 시간을 제공하여 재시도 성공 확률을 높입니다.

## 4. 재시도 + 지수 백오프 패턴의 동작 흐름

두 패턴을 결합하면 아래와 같은 흐름으로 동작합니다:

1. **요청 발생**: 외부 서비스나 API에 대한 요청이 발생합니다.
2. **요청 실패**: 요청이 실패할 경우, 즉시 재시도하지 않고 첫 번째 재시도 간격을 기다립니다.
3. **첫 번째 재시도**: 첫 번째 재시도는 짧은 대기 시간 후에 이루어집니다(예: 1초).
4. **지수 백오프 적용**: 재시도가 반복될수록 대기 시간이 두 배씩 증가합니다(1초, 2초, 4초, 8초 등).
5. **최대 재시도 횟수 도달**: 재시도가 설정된 최대 횟수를 초과하면, 더 이상 재시도하지 않고 실패 처리(예: 오류 반환)를 수행합니다.

## 5. 지수 백오프의 공식

지수 백오프는 일반적으로 다음과 같은 수학적 공식을 따릅니다:

```plaintext
backoff_time = base_interval * (2 ^ attempt)
base_interval: 기본 재시도 간격 (예: 1초).
attempt: 현재 재시도 횟수.

예시
1차 재시도: 1초 * (2 ^ 0) = 1초
2차 재시도: 1초 * (2 ^ 1) = 2초
3차 재시도: 1초 * (2 ^ 2) = 4초
4차 재시도: 1초 * (2 ^ 3) = 8초
이후: 재시도 간격이 점점 증가합니다.
```

## 6. 재시도 + 지수 백오프 패턴의 장점

- **단기 장애에 대한 복원력**: 외부 서비스의 일시적인 장애나 네트워크 문제에 유연하게 대응할 수 있습니다.
- **과부하 방지**: 재시도 간격이 점진적으로 늘어나기 때문에, 반복적인 요청이 시스템에 부담을 주지 않으며 서버가 안정적으로 복구될 시간을 확보합니다.
- **효율적인 리소스 사용**: 무작정 재시도하지 않고, 실패 가능성이 높을 때는 재시도 빈도를 낮추어 불필요한 리소스 낭비를 방지합니다.

## 7. 재시도 + 지수 백오프 패턴의 단점 및 고려 사항

- **최대 재시도 횟수 설정 필요**: 재시도를 무한정으로 수행하지 않도록, 최대 재시도 횟수를 설정하는 것이 중요합니다. 일반적으로 3~5회 정도가 적절합니다.
- **지연에 따른 사용자 경험 악화**: 재시도 간격이 길어지면 응답 시간이 길어져 사용자 경험이 저하될 수 있습니다. 중요한 요청에 대해서는 즉시 오류를 반환하는 것이 나을 수 있습니다.
- **동적 재시도 간격**: 모든 상황에서 동일한 재시도 간격을 적용하는 것이 최선은 아닙니다. 장애 유형에 따라 재시도 간격을 동적으로 조정하는 방식도 고려할 수 있습니다.

## 8. 사용 사례

### 8.1. 외부 API 호출 실패

외부 API 호출 시 일시적인 네트워크 장애가 발생한 경우, 재시도 패턴과 지수 백오프를 적용하여 과부하를 피하면서 장애가 복구될 때까지 재시도할 수 있습니다.

### 8.2. 메시지 큐 기반 비동기 작업

메시지 큐를 통해 작업을 처리하는 시스템에서 작업 처리 실패 시 일정 시간 간격으로 다시 시도하여 성공 가능성을 높일 수 있습니다. 백오프를 적용하면, 메시지가 실패했을 때 서버에 추가적인 부하를 주지 않고 점진적으로 재시도합니다.

## 9. 결론

재시도 패턴과 지수 백오프 패턴을 결합하면 시스템 장애에 대한 복원력을 높이고, 서버나 네트워크에 불필요한 부하를 방지할 수 있습니다. 이 패턴은 외부 서비스 호출, 네트워크 요청, 비동기 처리 등에서 자주 사용되며, 적절한 재시도 횟수와 대기 시간을 설정하는 것이 중요합니다.
