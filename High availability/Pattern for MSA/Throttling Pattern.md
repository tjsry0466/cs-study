# 유량 제어 패턴 (Throttling Pattern)

## 1. 개요

**유량 제어 패턴**(Throttling Pattern)은 시스템이 과부하 상태에 빠지지 않도록, 또는 외부 서비스의 호출을 제한하기 위해 요청의 양을 조절하는 패턴입니다. 이는 시스템이 처리할 수 있는 최대 용량을 초과하는 요청이 들어올 때 성능 저하나 장애를 예방하는 데 사용됩니다.

유량 제어는 서버에 과도한 요청이 몰리는 상황을 방지하거나, 외부 서비스의 API 호출 횟수 제한이 있을 때 효과적으로 사용됩니다. 이를 통해 서버 자원 낭비를 방지하고, 서비스 안정성을 높일 수 있습니다.

## 2. 유량 제어 패턴의 필요성

- **서버 과부하 방지**: 요청이 몰려 서버가 처리 용량을 초과할 경우 시스템 성능이 저하되거나 장애가 발생할 수 있습니다. 유량 제어는 이를 예방합니다.
- **서드파티 API 요청 제한 관리**: 외부 API는 일정 시간 내에 호출할 수 있는 요청 수를 제한하는 경우가 많습니다. 유량 제어를 사용하면 이러한 제한을 초과하지 않도록 관리할 수 있습니다.
- **비용 관리**: 클라우드 서비스 사용 시, 유량 제어로 특정 용량 이상의 요청을 차단하여 비용을 절감할 수 있습니다.

## 3. 유량 제어 방식

유량 제어 패턴은 여러 방식으로 구현되며, 시스템의 요구 사항에 따라 적절한 방식이 선택됩니다.

### 3.1. 고정 시간 창 (Fixed Window)

- 특정 시간 창(예: 1분) 동안 허용할 수 있는 최대 요청 수를 설정합니다. 해당 시간 동안 요청이 한도를 초과하면 남은 시간 동안 추가 요청은 차단됩니다.
- **예시**: 1분에 100개의 요청을 허용하는 경우, 101번째 요청은 거부됩니다. 다음 1분이 시작되면 다시 요청이 허용됩니다.

### 3.2. 슬라이딩 시간 창 (Sliding Window)

- 고정 시간 창과 유사하지만, 시간이 지나면서 요청 허용 수가 점진적으로 회복됩니다. 일정한 시간 간격으로 창이 슬라이딩하며 과거의 요청 내역을 기준으로 현재 허용할 수 있는 요청 수를 계산합니다.
- **예시**: 1분 동안 100개의 요청을 허용하는 경우, 매 초마다 요청이 1개씩 허용됩니다.

### 3.3. 토큰 버킷 (Token Bucket)

- 일정한 속도로 토큰이 버킷에 추가되고, 요청을 처리할 때마다 토큰을 소모합니다. 요청이 있을 때 토큰이 남아 있으면 요청을 처리하고, 토큰이 없으면 요청을 거부하거나 대기시킵니다.
- **예시**: 초당 10개의 토큰이 추가되고, 요청 시마다 토큰을 소모합니다. 토큰이 소진되면 요청은 대기하거나 거부됩니다.

### 3.4. 누적 버스트 (Leaky Bucket)

- 고정된 속도로 누출되는 버킷에 요청이 추가됩니다. 요청이 일정한 속도 이상으로 버킷을 채우면 넘치는 요청은 거부됩니다. 이를 통해 갑작스러운 트래픽 폭증을 완화할 수 있습니다.
- **예시**: 버킷에 초당 10개의 요청을 처리할 수 있으며, 이를 초과하면 요청이 거부됩니다.

## 4. 유량 제어 패턴의 장점

- **안정성 향상**: 서버나 서비스에 과도한 부하를 방지하여 안정성을 높일 수 있습니다.
- **비용 절감**: 외부 API 사용 시, 유량 제한을 통해 과도한 호출로 인한 비용을 방지할 수 있습니다.
- **성능 유지**: 과도한 트래픽이 발생할 경우 시스템 성능 저하를 예방하고, 다른 요청에 영향을 주지 않도록 관리할 수 있습니다.

## 5. 유량 제어 패턴의 단점 및 고려 사항

- **응답 지연**: 요청이 제한되거나 대기 상태에 놓이면 사용자 경험에 영향을 미칠 수 있습니다.
- **복잡성 증가**: 다양한 방식의 유량 제어 구현 및 관리가 필요하며, 특히 분산된 시스템에서는 더 많은 복잡성이 추가됩니다.
- **실시간 모니터링 필요**: 시스템의 현재 트래픽 상태를 실시간으로 모니터링하고, 유량 제어 설정을 동적으로 조정할 수 있는 환경이 필요할 수 있습니다.

## 6. 유량 제어 패턴의 사용 사례

- **API Gateway**: API Gateway에서 서드파티 API로 가는 요청을 제한하여 외부 API가 과부하에 걸리지 않도록 보호할 수 있습니다.
- **트래픽 관리**: 갑작스럽게 트래픽이 급증하는 경우, 유량 제어 패턴을 사용하여 시스템의 성능 저하를 방지할 수 있습니다.
- **사용자 요청 제한**: 각 사용자의 요청 수를 제한하여 시스템에 과도한 부하를 주는 사용자를 제어할 수 있습니다.

## 7. 결론

유량 제어 패턴은 시스템이 과부하나 외부 API의 호출 제한에 대비할 수 있는 중요한 패턴입니다. 적절하게 사용하면 시스템의 안정성과 성능을 유지하면서도 외부 서비스와의 연계를 효율적으로 관리할 수 있습니다. 다양한 방식의 유량 제어 방식 중, 시스템의 특성에 맞는 방식을 선택하여 구현하는 것이 중요합니다.
