# 회로 차단기 패턴 (Circuit Breaker Pattern)

## 1. 개요

**회로 차단기 패턴**(Circuit Breaker Pattern)은 시스템이 외부 서비스나 내부 리소스에 의존할 때, 해당 서비스가 장애를 일으키거나 응답하지 않을 경우 애플리케이션의 성능 저하를 방지하기 위한 패턴입니다. 서비스가 비정상적인 상태일 때 지속적으로 요청을 보내는 것은 시스템 자원을 낭비하고 장애를 악화시킬 수 있습니다. 이때, 회로 차단기 패턴을 통해 외부 서비스가 복구될 때까지 요청을 중단하고, 일정 시간 이후 다시 요청을 재개하는 방식으로 동작합니다.

회로 차단기 패턴은 물리적 전기 회로에서 사용하는 **회로 차단기**(Circuit Breaker)의 개념과 유사합니다. 과부하나 문제가 감지되면 회로를 차단하여 시스템에 손상을 주지 않도록 보호하고, 문제가 해결되면 다시 회로를 연결하여 정상 작동을 재개합니다.

## 2. 작동 방식

회로 차단기는 세 가지 주요 상태로 동작합니다:

1. **Closed(닫힘)**: 정상적인 상태로, 외부 서비스에 대한 모든 요청을 전달합니다.
2. **Open(열림)**: 서비스 장애가 발생한 상태로, 요청이 실패할 경우 요청을 차단하고, 외부 서비스로 더 이상 요청을 보내지 않습니다.
3. **Half-Open(반열림)**: 일정 시간이 지나면 회로 차단기는 일부 요청을 외부 서비스로 다시 보내서, 서비스가 복구되었는지 확인합니다. 성공하면 다시 **Closed(닫힘)** 상태로 전환하고, 실패하면 다시 **Open(열림)** 상태로 전환합니다.

## 3. 상태 전환 흐름

- **Closed(닫힘)**: 외부 서비스로 정상적인 요청을 보냅니다. 요청이 성공하면 상태는 유지되지만, 요청이 지속적으로 실패할 경우 차단기 상태는 Open으로 전환됩니다.
- **Open(열림)**: 일정 횟수 이상의 실패가 감지되면 차단기는 Open 상태로 전환되고, 더 이상 외부 서비스로 요청을 보내지 않습니다. 이 상태에서는 즉시 실패 응답을 반환하거나 대체 작업(Graceful Degradation)을 수행할 수 있습니다.

- **Half-Open(반열림)**: 일정 시간 후, 차단기는 자동으로 Half-Open 상태로 전환되어 외부 서비스에 몇 가지 요청을 다시 보냅니다. 요청들이 성공하면 Closed 상태로 돌아가고, 실패하면 다시 Open 상태로 전환됩니다.

## 4. 회로 차단기 패턴의 동작 흐름

```plaintext
    정상 상태    ->   오류 발생 횟수 초과  ->  차단기 열림
   (Closed)      ->   (실패율 증가)       ->  (Open)
       ^                                      |
       |                                      v
  (Half-Open)   <- 일정 시간 경과 후 테스트 <-  서비스 복구
       |                                      |
       v                                      v
  정상 상태로 복귀                    테스트 실패 -> 다시 Open 상태
   (Closed)
```

## 5. 회로 차단기 패턴의 장점

- **시스템 보호**: 외부 서비스나 내부 리소스가 장애를 일으킬 때, 회로 차단기를 통해 애플리케이션이 더 이상 요청을 보내지 않도록 하여 자원 낭비를 방지합니다.
- **장애 격리**: 장애가 발생한 부분을 격리하여 전체 시스템에 영향을 미치지 않도록 하고, 나머지 서비스는 정상적으로 작동할 수 있게 합니다.
- **Graceful Degradation**: 외부 서비스가 실패할 경우, 회로 차단기를 통해 대체 응답을 반환하여 사용자에게 최소한의 기능을 제공하거나 에러 메시지를 전달합니다.

## 6. 회로 차단기 패턴의 단점 및 고려 사항

- **오버헤드**: 회로 차단기 자체도 모니터링 및 상태 관리를 위해 일정한 시스템 리소스를 소비하므로, 복잡한 시스템에서는 추가적인 오버헤드가 발생할 수 있습니다.
- **오탐(오류 탐지 실패)**: 회로 차단기의 실패 기준이나 설정이 적절하지 않으면 정상적인 요청도 차단될 수 있습니다. 즉, 성급하게 차단기를 열어버릴 경우 필요하지 않은 요청까지 차단될 수 있습니다.
- **테스트와 복구 전략**: Half-Open 상태에서 충분한 테스트가 이루어지지 않으면, 회복된 서비스에 대한 재시도가 실패할 수 있으므로 신중한 복구 전략이 필요합니다.

## 7. 회로 차단기 패턴이 사용되는 시나리오

- **서드파티 API 의존성**: 외부 API 또는 서드파티 서비스에 의존하는 애플리케이션에서, 해당 서비스에 장애가 발생하면 회로 차단기를 사용하여 애플리케이션의 나머지 부분이 영향을 받지 않도록 보호합니다.
- **대규모 분산 시스템**: 마이크로서비스 아키텍처와 같이 분산된 환경에서 여러 서비스 간의 호출이 빈번할 때, 한 서비스에서 발생한 장애가 다른 서비스로 전파되는 것을 방지하기 위해 회로 차단기를 적용할 수 있습니다.
- **대규모 트래픽 관리**: 트래픽이 갑자기 급증하는 상황에서, 외부 리소스가 과부하에 걸리면 회로 차단기가 이를 감지하고 서비스 장애를 방지할 수 있습니다.

## 8. 회로 차단기 패턴의 구성 요소

- **차단 기준 (Failure Threshold)**: 실패로 간주하는 요청 비율 또는 횟수를 기준으로 설정합니다. 예를 들어, 10번의 요청 중 5번 이상 실패하면 차단기로 전환하는 방식입니다.
- **차단 시간 (Open Interval)**: 차단기가 열리면, 일정 시간 동안 모든 요청을 차단한 후 재시도합니다. 이 시간은 서비스 복구를 기다리는 시간입니다.
- **상태 모니터링**: 서비스 상태를 지속적으로 모니터링하여 정상 상태로 복구되면 다시 차단기를 닫아 정상적인 요청 처리가 가능하도록 설정합니다.
- **재시도 정책 (Retry Policy)**: 서비스가 복구되었는지 확인하기 위해 일정 시간 후에 일부 요청을 다시 시도하는 정책을 구성합니다.

## 9. 회로 차단기 패턴의 사례

### 9.1. Netflix Hystrix

Netflix의 Hystrix는 회로 차단기 패턴을 구현한 대표적인 라이브러리로, 마이크로서비스 환경에서 장애를 감지하고 빠르게 서비스 격리를 실행하여 시스템을 보호합니다. 비정상적인 상태가 감지되면, Hystrix는 즉시 회로를 열어 외부 서비스로의 요청을 차단합니다.

### 9.2. Resilience4j

Resilience4j는 Hystrix의 대체 라이브러리로, 간결하고 효율적인 회로 차단기 패턴을 제공합니다. Spring Boot 환경에서 쉽게 통합할 수 있으며, 회로 차단기 외에도 재시도, 제한기, 버퍼 등의 다양한 내결함성 패턴을 지원합니다.

## 10. 결론

회로 차단기 패턴은 고가용성을 유지하면서 외부 서비스나 리소스의 장애로부터 시스템을 보호하는 중요한 패턴입니다. 회로 차단기를 사용하면 장애가 발생한 서비스에 대한 지속적인 요청을 방지하고, 나머지 시스템에 미치는 영향을 최소화할 수 있습니다. 또한, 회복이 가능한 상태에서는 점진적으로 요청을 재개하여 시스템을 안전하게 운영할 수 있습니다. 외부 API나 마이크로서비스를 사용하는 애플리케이션에서 이 패턴을 활용하면 장애에 대한 복원력을 높이고 안정적인 서비스를 제공할 수 있습니다.
