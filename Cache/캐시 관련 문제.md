# 캐시 관련 문제

## 1. Cache Stampede 현상이란?

**Cache Stampede**는 캐시가 만료되는 시점에 대규모 트래픽이 몰리면서, 여러 애플리케이션 서버가 동시에 캐시된 데이터를 재생성하려고 할 때 발생하는 성능 문제를 말합니다. 이 현상은 캐시된 데이터의 **TTL**(Time-To-Live)이 만료되었을 때, 다수의 요청이 동시에 원본 데이터 소스(예: 데이터베이스)로 몰리는 상황에서 주로 발생합니다.

### 1.1 Cache Stampede 발생 원인

- **TTL 설정의 중요성**: TTL이 지나면 캐시에 저장된 데이터는 만료되어 제거되며, 이후 해당 데이터에 대한 요청이 발생하면 **캐시 미스(Cache Miss)**가 발생합니다. TTL이 너무 짧게 설정되면 데이터가 자주 만료되어 캐시 미스가 빈번하게 발생할 수 있습니다.

- **Look-Aside 패턴에서의 Cache Stampede**: **Look-Aside (Cache Aside) 패턴**에서는 데이터 조회 시 애플리케이션이 먼저 캐시를 확인하고, 캐시에 데이터가 없으면(DB에서 데이터를 가져와 캐시에 저장) 데이터베이스에서 직접 데이터를 조회합니다. 이 과정에서 다수의 서버가 동시에 데이터베이스로 접근하게 되면 **Cache Stampede**가 발생합니다.

- **키 만료 시의 문제**: 캐시에 저장된 특정 **키가 만료**되면, 그 키를 참조하는 모든 애플리케이션 서버가 동시에 데이터베이스로 접근하여 데이터를 가져오려 할 수 있습니다. 이로 인해 **Duplicate Read**와 **Duplicate Write**가 발생합니다.

### 1.2 Cache Stampede로 인한 문제

- **Duplicate Read**: 여러 서버가 동일한 데이터를 동시에 데이터베이스에서 읽어오는 현상으로, 데이터베이스에 과도한 부하가 발생할 수 있습니다.

- **Duplicate Write**: 동일한 데이터를 캐시에 쓰기 작업을 여러 서버가 동시에 수행하는 현상으로, 불필요한 중복 작업이 발생하여 캐시의 효율이 떨어지고 시스템 성능이 저하됩니다.

- **성능 저하 및 시스템 장애**: Cache Stampede는 서버 부하를 급격히 증가시키며, 최악의 경우 시스템 장애로 이어질 수 있습니다.

### 1.3 Cache Stampede 방지 대책

- **Expiration Spread**: TTL 설정 시, 캐시 만료 시간을 균등하게 분산하여 특정 시점에 모든 캐시가 동시에 만료되지 않도록 합니다.

- **Lazy Loading with Semaphore**: **세마포어**(Semaphore)를 사용하여, 캐시 미스가 발생한 경우 한 번에 하나의 서버만 데이터베이스에 접근하도록 제어합니다.

- **Early Expiration and Preemptive Refresh**: 데이터가 만료되기 전에 캐시를 미리 갱신하여 Cache Stampede를 예방합니다.

- **Write-Behind Caching**: 데이터를 캐시에 먼저 저장하고 일정 주기마다 데이터베이스에 쓰는 방식으로, Cache Stampede로 인한 데이터베이스 부하를 줄입니다.

- **Thundering Herd 문제 방지**: **Thundering Herd 문제**는 Cache Stampede와 유사하게, 동일한 데이터에 대한 다수의 요청이 동시에 발생할 때 시스템에 과도한 부하가 걸리는 문제입니다. 이를 방지하기 위해 **락(Lock) 메커니즘**을 도입하거나, **백오프(Backoff) 알고리즘**을 사용하여 요청을 제어합니다.

## 2. 기타 캐시 관련 문제와 해결 방안

### 2.1 캐시 관통(Cache Penetration)

캐시에서 null 값이 반환된 후 데이터베이스에서 동일한 null 값을 반복적으로 조회하는 상황을 의미합니다. 이로 인해 불필요한 데이터베이스 부하가 발생할 수 있습니다.

#### 해결 방법: 널 오브젝트 패턴(Null Object Pattern)

데이터가 없다는 사실도 캐싱하여 데이터베이스 조회를 줄입니다.

### 2.2 핫키(Hotkey) 만료

특정 키에 많은 요청이 집중되는 상황에서 해당 키가 만료될 때, 동시에 여러 요청이 데이터베이스를 반복 조회하는 문제입니다.

#### 해결 방법: 분산 락(Distributed Lock)

캐시 미스 시 분산 락을 사용해 한 번의 쓰기 작업만 허용하여 데이터베이스 중복 조회를 방지합니다.

## 3. 결론

캐시 시스템은 데이터베이스 부하를 줄이기 위한 중요한 도구이지만, 잘못 설계되거나 운영되면 Cache Stampede와 같은 심각한 성능 문제를 초래할 수 있습니다. TTL 설정, 세마포어 사용, 캐시 갱신 전략 등을 통해 Cache Stampede와 기타 캐시 관련 문제를 예방함으로써, 시스템 성능을 유지하고 장애를 예방할 수 있습니다.
